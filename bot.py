import os
import asyncio
from dataclasses import dataclass
from typing import Optional, Dict, Tuple

from dotenv import load_dotenv

from aiogram import Bot, Dispatcher, F
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardButton,
)
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.exceptions import TelegramBadRequest


# =========================
# ENV
# =========================
load_dotenv()

BOT_TOKEN = (os.getenv("BOT_TOKEN") or "").strip()
ADMIN_CHAT_ID_RAW = (os.getenv("ADMIN_CHAT_ID") or "0").strip()

if not BOT_TOKEN or ":" not in BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN is missing/invalid in .env")

try:
    ADMIN_CHAT_ID = int(ADMIN_CHAT_ID_RAW)
except ValueError:
    ADMIN_CHAT_ID = 0


# =========================
# Copy (client-facing)
# =========================

START_TEXT = (
    "–í—ñ—Ç–∞—é ü§ç\n"
    "–Ø –±–æ—Ç-–ø–æ–º—ñ—á–Ω–∏–∫ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–Ω—ñ –¢–µ—Ç—è–Ω–∏ –í–∞–∫–∞—Ä—é–∫.\n"
    "–ú–æ–∂–µ—à –æ–±—Ä–∞—Ç–∏ –∑–∞–ø–∏—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é –∞–±–æ –Ω–∞–ø–∏—Å–∞—Ç–∏, —â–æ–± —É—Ç–æ—á–Ω–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç —ñ –¥–µ—Ç–∞–ª—ñ.\n"
    "–î—è–∫—É—é, —â–æ —Ç–∏ —Ç—É—Ç.\n"
    "–û–±–∏—Ä–∞–π üëáüèª"
)

BOOKING_INTRO = (
    "–û–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç:\n\n"
    "<b>üå± –†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è</b>\n"
    "(—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ —Ä–æ–±–æ—Ç–∞)\n\n"
    "–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∑ –æ–ø–æ—Ä–æ—é –Ω–∞ –≥–µ—à—Ç–∞–ª—å—Ç-–ø—ñ–¥—Ö—ñ–¥.\n"
    "–ü—ñ–¥—ñ–π–¥–µ, —è–∫—â–æ:\n"
    "‚Äì —î –±–∞–∂–∞–Ω–Ω—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö –∑–º—ñ–Ω, –Ω–∞–≤—ñ—Ç—å –±–µ–∑ —á—ñ—Ç–∫–æ–≥–æ –∑–∞–ø–∏—Ç—É\n"
    "‚Äì –≤–∞–∂–ª–∏–≤–∞ –≥–Ω—É—á–∫—ñ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—É —ñ –≥–ª–∏–±–∏–Ω–Ω–µ –∑–∞–Ω—É—Ä–µ–Ω–Ω—è\n\n"
    "–ó–∞–ø–∏—Ç –º–æ–∂–µ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏—Å—å —É –ø—Ä–æ—Ü–µ—Å—ñ —Ä–æ–±–æ—Ç–∏.\n"
    "<i>50 —Ö–≤ ¬∑ 40 ‚Ç¨</i>\n\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    "<b>üß† –ü–µ—Ä–≤–∏–Ω–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á</b>\n"
    "(–¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Å–∏—Ö—ñ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É)\n\n"
    "–î–æ—Å–ª—ñ–¥–Ω–∏—Ü—å–∫–∞ —Å–µ—Å—ñ—è, —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –Ω–∞:\n"
    "‚Äì –æ—Ü—ñ–Ω–∫—É –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É\n"
    "‚Äì –ø—Ä–æ—è—Å–Ω–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ç—Ä—É–¥–Ω–æ—â—ñ–≤ —ñ –Ω–∞–ø—Ä—É–∂–µ–Ω—å\n"
    "‚Äì –ø–µ—Ä–≤–∏–Ω–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –ø—Å–∏—Ö—ñ—á–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤ º—è —ñ –ø–æ–¥–∞–ª—å—à–æ—ó —Ä–æ–±–æ—Ç–∏\n\n"
    "–¶–µ –Ω–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ —Å–µ—Å—ñ—è, –∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–æ-–¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç.\n"
    "<i>40 —Ö–≤ ¬∑ 30 ‚Ç¨</i>\n\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    "<b>üîç –†–∞–∑–æ–≤–∞ –≥–ª–∏–±–∏–Ω–Ω–∞ —Å–µ—Å—ñ—è</b>\n"
    "(—Ç–æ—á–∫–æ–≤–∞ —Ä–æ–±–æ—Ç–∞ –ø–æ –∑–∞–ø–∏—Ç—É)\n\n"
    "–û–¥–Ω–∞ –ø–æ–¥–æ–≤–∂–µ–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á –¥–ª—è:\n"
    "‚Äì –≥–æ—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–∏—Ç—É –∞–±–æ —Å–∫–ª–∞–¥–Ω–æ–≥–æ –µ–ø—ñ–∑–æ–¥—É\n"
    "‚Äì –∫—Ä–∏–∑–æ–≤–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏\n"
    "‚Äì –≥–ª–∏–±—à–æ–≥–æ –∑–∞–Ω—É—Ä–µ–Ω–Ω—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É —Ç–µ–º—É\n\n"
    "–§–æ—Ä–º–∞—Ç —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—ó, —Å—Ñ–æ–∫—É—Å–æ–≤–∞–Ω–æ—ó —Ä–æ–±–æ—Ç–∏.\n"
    "<i>90 —Ö–≤ ¬∑ 75 ‚Ç¨</i>\n\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    "<b>üß© –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî 4 –∑—É—Å—Ç—Ä—ñ—á—ñ</b>\n\n"
    "–ü–∞–∫–µ—Ç –∑ 4 —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏—Ö —Å–µ—Å—ñ–π.\n"
    "(–∑—ñ –∑–Ω–∏–∂–∫–æ—é –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ —Ä–∞–∑–æ–≤–æ—é –æ–ø–ª–∞—Ç–æ—é)\n"
    "–ü—ñ–¥—ñ–π–¥–µ, —è–∫—â–æ:\n"
    "‚Äì —î –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –æ–¥—Ä–∞–∑—É –π—Ç–∏ –≤ –≥–ª–∏–±–∏–Ω—É\n"
    "‚Äì —Ö–æ—á–µ—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ —Ç–µ–º–ø—É —ñ –ø—Ä–æ—Ü–µ—Å—É\n\n"
    "<i>50 —Ö–≤ ¬∑ 145 ‚Ç¨</i>\n\n"
    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    "üëáüèª –û–±–∏—Ä–∞–π —Ñ–æ—Ä–º–∞—Ç, —è–∫–∏–π –∑–∞—Ä–∞–∑ –≤—ñ–¥–≥—É–∫—É—î—Ç—å—Å—è.\n"
    "–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É —Ç–∏ –ø–æ–±–∞—á–∏—à –¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —ñ –∑–º–æ–∂–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑–∞–ø–∏—Å."
)

PRECONTACT_TEXT = (
    "–Ü–Ω–æ–¥—ñ –ø–µ—Ä–µ–¥ —Ä—ñ—à–µ–Ω–Ω—è–º –≤–∞–∂–ª–∏–≤–æ —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –∫–æ–Ω—Ç–∞–∫—Ç—É —ñ —è—Å–Ω–æ—Å—Ç—ñ.\n"
    "–ù–∞–ø–∏—à–∏, –±—É–¥—å –ª–∞—Å–∫–∞, –∫—ñ–ª—å–∫–∞ —Å–ª—ñ–≤ —á–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è ‚Äî —è –≤—ñ–¥–ø–æ–≤—ñ–º —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–π–Ω–æ –º–∞—Ç–∏–º—É –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å."
)

PAY_THANKS_TEXT = (
    "–î—è–∫—É—é –∑–∞ –æ–ø–ª–∞—Ç—É ü§ç\n"
    "–Ø –æ—Ç—Ä–∏–º–∞—é –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —ñ –≤—ñ–¥–ø–æ–≤—ñ–º —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–± —É–∑–≥–æ–¥–∏—Ç–∏ –∑—Ä—É—á–Ω–∏–π –¥–µ–Ω—å —ñ —á–∞—Å."
)

INFO_ROOT_TEXT = (
    "‚ÑπÔ∏è <b>–£—Ç–æ—á–Ω–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó</b>\n\n"
    "–û–±–µ—Ä–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î.\n"
    "–Ø –≤—ñ–¥–ø–æ–≤—ñ–º —ñ –¥–æ–ø–æ–º–æ–∂—É –∑–æ—Ä—ñ—î–Ω—Ç—É–≤–∞—Ç–∏—Å—è."
)

INFO_FORMAT_TEXT = (
    "üß≠ <b>–Ø–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –ø—ñ–¥—ñ–π–¥–µ –ø—ñ–¥ –º—ñ–π –∑–∞–ø–∏—Ç?</b>\n\n"
    "–Ø–∫—â–æ –∫–æ—Ä–æ—Ç–∫–æ:\n\n"
    "‚Ä¢ <b>üå± –†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è</b> ‚Äî —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ —ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∑–º—ñ–Ω–∏.\n"
    "‚Ä¢ <b>üß† –ü–µ—Ä–≤–∏–Ω–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á</b> ‚Äî –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó.\n"
    "‚Ä¢ <b>üîç –†–∞–∑–æ–≤–∞ –≥–ª–∏–±–∏–Ω–Ω–∞ —Å–µ—Å—ñ—è</b> ‚Äî –≥–æ—Å—Ç—Ä–∏–π –∞–±–æ –∫—Ä–∏–∑–æ–≤–∏–π –∑–∞–ø–∏—Ç.\n"
    "‚Ä¢ <b>üß© –ü–∞–∫–µ—Ç —ñ–∑ 4 –∑—É—Å—Ç—Ä—ñ—á–µ–π</b> ‚Äî –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –≥–æ—Ç–æ–≤–∏–π –æ–¥—Ä–∞–∑—É –∑–∞—Ö–æ–¥–∏—Ç–∏ –≤ –ø—Ä–æ—Ü–µ—Å.\n\n"
    "–Ø–∫—â–æ —Å–∫–ª–∞–¥–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏—Å—å ‚Äî —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.\n"
    "–ú–æ–∂–µ—à –æ–ø–∏—Å–∞—Ç–∏ —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü—ñ—é –Ω–∏–∂—á–µ, —ñ —è –≤—ñ–¥–ø–æ–≤—ñ–º –æ—Å–æ–±–∏—Å—Ç–æ."
)

INFO_PAYMENT_TEXT = (
    "üí≥ <b>–ü—Ä–æ –æ–ø–ª–∞—Ç—É —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω—ñ –¥–µ—Ç–∞–ª—ñ</b>\n\n"
    "–û–ø–ª–∞—Ç—É –º–æ–∂–Ω–∞ –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ü—å–æ–º—É –±–æ—Ç—ñ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É —Ñ–æ—Ä–º–∞—Ç—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó.\n\n"
    "–¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –æ–ø–ª–∞—Ç–∏ –ø—ñ–¥ —á–∞—Å –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—É ‚Äî —É –ø–µ—Ä–µ–ø–∏—Å—Ü—ñ –∑—ñ –º–Ω–æ—é.\n\n"
    "–û–ø–ª–∞—Ç–∞ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –¥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó.\n\n"
    "–Ø–∫—â–æ –º–∞—î—à –∑–∞–ø–∏—Ç–∞–Ω–Ω—è ‚Äî –Ω–∞–ø–∏—à–∏ —ó—Ö –Ω–∏–∂—á–µ."
)

INFO_BOOKING_TEXT = (
    "üóì <b>–ó–∞–ø–∏—Å —Ç–∞ —É–∑–≥–æ–¥–∂–µ–Ω–Ω—è —á–∞—Å—É</b>\n\n"
    "–ó–∞–ø–∏—Å –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —É –∫—ñ–ª—å–∫–∞ –∫—Ä–æ–∫—ñ–≤:\n\n"
    "1Ô∏è‚É£ –¢–∏ –æ–±–∏—Ä–∞—î—à —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó.\n"
    "2Ô∏è‚É£ –û–ø–ª–∞—á—É—î—à –∑—É—Å—Ç—Ä—ñ—á –∞–±–æ –∑–∞–ª–∏—à–∞—î—à –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–Ω—Ç–∞–∫—Ç.\n"
    "3Ô∏è‚É£ –Ø –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —ñ –º–∏ —Ä–∞–∑–æ–º —É–∑–≥–æ–¥–∂—É—î–º–æ –∑—Ä—É—á–Ω–∏–π –¥–µ–Ω—å —ñ —á–∞—Å.\n\n"
    "–Ø–∫—â–æ —Ö–æ—á–µ—à —â–æ—Å—å —É—Ç–æ—á–Ω–∏—Ç–∏ ‚Äî –Ω–∞–ø–∏—à–∏ –Ω–∏–∂—á–µ."
)

INFO_HARD_TEXT = (
    "üò• <b>–ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ —Å–∫–ª–∞–¥–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏—Å—å</b>\n\n"
    "–¶–µ –æ–∫ ‚Äî –Ω–µ –∑–∞–≤–∂–¥–∏ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –æ–¥—Ä–∞–∑—É.\n\n"
    "–ú–æ–∂–µ—à –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—Å–∞—Ç–∏, —â–æ –∑ —Ç–æ–±–æ—é –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–±–æ —â–æ —Å–∞–º–µ –≤–∏–∫–ª–∏–∫–∞—î —Å—É–º–Ω—ñ–≤–∏.\n"
    "–Ø –≤—ñ–¥–ø–æ–≤—ñ–º –æ—Å–æ–±–∏—Å—Ç–æ."
)

INFO_OTHER_TEXT = (
    "‚úçüèª <b>–Ü–Ω—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è</b>\n\n"
    "–ù–∞–ø–∏—à–∏, –±—É–¥—å –ª–∞—Å–∫–∞, —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è –Ω–∏–∂—á–µ.\n"
    "–Ø –≤—ñ–¥–ø–æ–≤—ñ–º —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ–π–Ω–æ –º–∞—Ç–∏–º—É –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å."
)

INFO_BOOKING_CONFIRM_TEXT = (
    "–î—è–∫—É—é ü§ç\n\n"
    "–Ø –Ω–∞–ø–∏—à—É —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è,\n"
    "—â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –≤–∏–±–æ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç—É\n"
    "—Ç–∞ —É–∑–≥–æ–¥–∏—Ç–∏ –∑—Ä—É—á–Ω–∏–π –¥–µ–Ω—å —ñ —á–∞—Å."
)

CONTACT_CONFIRM_TEXT = (
    "–Ø —Ç—É—Ç ü§ç\n\n"
    "–Ø –ø–æ–±–∞—á–∏–ª–∞ —Ç–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.\n"
    "–Ø–∫—â–æ –∑–∞—Ö–æ—á–µ—à —â–æ—Å—å –¥–æ–¥–∞—Ç–∏ –∞–±–æ —É—Ç–æ—á–Ω–∏—Ç–∏ ‚Äî\n"
    "–º–æ–∂–µ—à –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç–∏ —Ü–µ –Ω–∏–∂—á–µ."
)



# =========================
# Services
# =========================

@dataclass(frozen=True)
class Service:
    key: str
    title: str  # for button text
    pay_url: str
    details_text: str


# !!! –í–ê–ñ–õ–ò–í–û: —Å—é–¥–∏ –≤—Å—Ç–∞–≤–∏—à —Å–≤–æ—ó Stripe links (–∑–∞–º—ñ–Ω–∏ –ø—Ä–∏–∫–ª–∞–¥–∏).
SERVICES: Dict[str, Service] = {}

SERVICES["regular"] = Service(
    key="regular",
    title="üå± –†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è",
    pay_url="https://secure.wayforpay.com/button/bb990ba9c0945",
    details_text=(
        "<b>üå± –†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è</b>\n"
        "–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ ¬∑ 50 —Ö–≤\n\n"
        "–¶–µ —Ñ–æ—Ä–º–∞—Ç —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –æ–ø–æ—Ä–æ—é –Ω–∞ –≥–µ—à—Ç–∞–ª—å—Ç-–ø—ñ–¥—Ö—ñ–¥ ‚Äî –ø—Ä–æ –ø—Ä–æ—Ü–µ—Å, –∫–æ–Ω—Ç–∞–∫—Ç —ñ –ø–æ—Å—Ç—É–ø–æ–≤—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∑–º—ñ–Ω–∏.\n"
        "–†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç—ñ—Ä, —É —è–∫–æ–º—É:\n"
        "‚Ä¢ –º–æ–∂–Ω–∞ –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞—Ç–∏ —Å–≤—ñ–π –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –¥–æ—Å–≤—ñ–¥ —É –±–µ–∑–ø–µ—á–Ω–æ–º—É —Ç–µ–º–ø—ñ\n"
        "‚Ä¢ –ø–æ–º—ñ—á–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω—ñ –µ–º–æ—Ü—ñ–π–Ω—ñ —Ç–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–æ–≤—ñ –ø–∞—Ç–µ—Ä–Ω–∏\n"
        "‚Ä¢ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–Ω—è–º–∏, —Å—Ç–æ—Å—É–Ω–∫–∞–º–∏, —Å–∞–º–æ–æ—Ü—ñ–Ω–∫–æ—é, –º–µ–∂–∞–º–∏\n"
        "‚Ä¢ –ø–æ—Å—Ç—É–ø–æ–≤–æ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Å–ø–æ—Å–æ–±–∏ –±—É—Ç–∏ –∑ —Å–æ–±–æ—é —Ç–∞ –∑ —ñ–Ω—à–∏–º–∏\n\n"
        "–ó–∞–ø–∏—Ç –º–æ–∂–µ –±—É—Ç–∏, –∞ –º–æ–∂–µ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏—Å—è –≤–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—ñ.\n"
        "–†–æ–±–æ—Ç–∞ –Ω–µ –∑–≤–æ–¥–∏—Ç—å—Å—è –¥–æ ¬´–≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏¬ª, –∞ —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –Ω–∞ –≥–ª–∏–±—à–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Å–≤–æ—ó—Ö –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ —ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –æ–ø–æ—Ä–∏.\n"
        "–§–æ—Ä–º–∞—Ç –ø–µ—Ä–µ–¥–±–∞—á–∞—î:\n"
        "‚Ä¢ –≥–Ω—É—á–∫—ñ—Å—Ç—å —ñ —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å –¥–æ —Ç–æ–≥–æ, —â–æ –∞–∫—Ç—É–∞–ª—å–Ω–µ —Å–∞–º–µ –∑–∞—Ä–∞–∑\n"
        "‚Ä¢ —É–≤–∞–≥—É –¥–æ —Ç—ñ–ª–µ—Å–Ω–∏—Ö, –µ–º–æ—Ü—ñ–π–Ω–∏—Ö —ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏—Ö –ø—Ä–æ—è–≤—ñ–≤\n"
        "‚Ä¢ —Ä—É—Ö —É —Ç–µ–º–ø—ñ, —è–∫–∏–π –≤–∏—Ç—Ä–∏–º—É—î—Ç—å—Å—è\n\n"
        "–†–µ–≥—É–ª—è—Ä–Ω—ñ –∑—É—Å—Ç—Ä—ñ—á—ñ –¥–∞—é—Ç—å –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –Ω–µ –ø–æ—Å–ø—ñ—à–∞—Ç–∏ –∑ –≤–∏—Å–Ω–æ–≤–∫–∞–º–∏,\n"
        "–∞ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–º—ñ–Ω–∞–º –≤–∏–∑—Ä—ñ–≤–∞—Ç–∏ –π —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏—Å—è –≤ –∂–∏—Ç—Ç—è."
    ),
)

SERVICES["initial"] = Service(
    key="initial",
    title="üß† –ü–µ—Ä–≤–∏–Ω–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á",
    pay_url="https://secure.wayforpay.com/button/b3061edbcba90",
    details_text=(
        "<b>üß† –ü–µ—Ä–≤–∏–Ω–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á</b>\n"
        "–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Å–∏—Ö—ñ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É ¬∑ 40 —Ö–≤\n\n"
        "–¶–µ –¥–æ—Å–ª—ñ–¥–Ω–∏—Ü—å–∫–∞ –∑—É—Å—Ç—Ä—ñ—á, —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –Ω–∞ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Ç–≤–æ–≥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É.\n"
        "–ù–∞ —Ü—ñ–π —Å–µ—Å—ñ—ó –º–∏:\n"
        "‚Äì –¥–æ—Å–ª—ñ–¥–∂—É—î–º–æ, —â–æ –∑ —Ç–æ–±–æ—é –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞—Ä–∞–∑\n"
        "‚Äì –¥–∏–≤–∏–º–æ—Å—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ñ –∑–æ–Ω–∏ –Ω–∞–ø—Ä—É–∂–µ–Ω–Ω—è, –≤—Ç–æ–º–∏ –∞–±–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É\n"
        "‚Äì –æ–∫—Ä–µ—Å–ª—é—î–º–æ –º–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏ —Ç—Ä—É–¥–Ω–æ—â—ñ–≤\n"
        "‚Äì —Ñ–æ—Ä–º—É—î–º–æ –ø–µ—Ä–≤–∏–Ω–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –ø—Å–∏—Ö—ñ—á–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤ º—è —ñ –ø–æ–¥–∞–ª—å—à–∏—Ö –∫—Ä–æ–∫—ñ–≤\n\n"
        "–§–æ—Ä–º–∞—Ç –º–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏:\n"
        "‚Äì —É—Ç–æ—á–Ω—é–≤–∞–ª—å–Ω—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è\n"
        "‚Äì –∫–æ—Ä–æ—Ç–∫—ñ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∞–±–æ —Ç–µ—Å—Ç–∏\n"
        "‚Äì —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–Ω–Ω—è —Ç–æ–≥–æ, —â–æ –∑–∞—Ä–∞–∑ –≤–∏–≥–ª—è–¥–∞—î —Ö–∞–æ—Ç–∏—á–Ω–∏–º –∞–±–æ –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–º\n\n"
        "–¶–µ –Ω–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ —ñ –Ω–µ –ø—Ä–æ—Ü–µ—Å –∑–º—ñ–Ω ‚Äî\n"
        "—Ü–µ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è, –∞–Ω–∞–ª—ñ–∑ —ñ —è—Å–Ω—ñ—Å—Ç—å.\n\n"
        "–ü—ñ—Å–ª—è –∑—É—Å—Ç—Ä—ñ—á—ñ —Ç–∏:\n"
        "‚Äì –∫—Ä–∞—â–µ —Ä–æ–∑—É–º—ñ—î—à —Å–≤—ñ–π —Å—Ç–∞–Ω\n"
        "‚Äì –º–∞—î—à —á—ñ—Ç–∫—ñ—à—É –∫–∞—Ä—Ç–∏–Ω—É, –∑ —á–∏–º —ñ —è–∫ –º–æ–∂–Ω–∞ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–∞–ª—ñ\n"
        "‚Äì –º–æ–∂–µ—à —É—Å–≤—ñ–¥–æ–º–ª–µ–Ω–æ –æ–±—Ä–∞—Ç–∏ —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–∞–ª—å—à–æ—ó —Ä–æ–±–æ—Ç–∏"
    ),
)

SERVICES["deep"] = Service(
    key="deep",
    title="üîç –†–∞–∑–æ–≤–∞ –≥–ª–∏–±–∏–Ω–Ω–∞ —Å–µ—Å—ñ—è",
    pay_url="https://secure.wayforpay.com/button/bc2c54f078393",
    details_text=(
        "<b>üîç –†–∞–∑–æ–≤–∞ –≥–ª–∏–±–∏–Ω–Ω–∞ —Å–µ—Å—ñ—è</b>\n"
        "–¢–æ—á–∫–æ–≤–∞ —Ä–æ–±–æ—Ç–∞ –ø–æ –∑–∞–ø–∏—Ç—É ¬∑ 90 —Ö–≤\n\n"
        "–¶–µ –ø–æ–¥–æ–≤–∂–µ–Ω–∞ —Å–µ—Å—ñ—è –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º, –∞–∫—Ç—É–∞–ª—å–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º –∞–±–æ —Å–∫–ª–∞–¥–Ω–æ—é —Å–∏—Ç—É–∞—Ü—ñ—î—é.\n"
        "–§–æ—Ä–º–∞—Ç –ø—ñ–¥—ñ–π–¥–µ, —è–∫—â–æ:\n"
        "‚Ä¢ —î –≥–æ—Å—Ç—Ä–∏–π –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –∞–±–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–æ–Ω—Ñ–ª—ñ–∫—Ç\n"
        "‚Ä¢ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∫—Ä–∏–∑–æ–≤–∏–π –ø–µ—Ä—ñ–æ–¥ –∞–±–æ –≤–∞–∂–∫–∞ –ø–æ–¥—ñ—è\n"
        "‚Ä¢ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—É–ø–∏–Ω–∏—Ç–∏—Å—å —ñ –≥–ª–∏–±—à–µ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ –æ–¥–Ω—É —Ç–µ–º—É\n"
        "‚Ä¢ –≤–∞–∂–ª–∏–≤–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —ñ —è—Å–Ω—ñ—Å—Ç—å —É —Å–∫–ª–∞–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç\n\n"
        "–ù–∞ —Ü—ñ–π –∑—É—Å—Ç—Ä—ñ—á—ñ –º–∏:\n"
        "‚Ä¢ –∑–æ—Å–µ—Ä–µ–¥–∂—É—î–º–æ—Å—å –Ω–∞ –æ–¥–Ω–æ–º—É –∫–ª—é—á–æ–≤–æ–º—É –∑–∞–ø–∏—Ç—ñ\n"
        "‚Ä¢ –¥–µ—Ç–∞–ª—å–Ω–æ –¥–æ—Å–ª—ñ–¥–∂—É—î–º–æ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–Ω—è, —Ä–µ–∞–∫—Ü—ñ—ó —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏\n"
        "‚Ä¢ —à—É–∫–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ —Ç–æ—á–∫–∏ –æ–ø–æ—Ä–∏ —ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –ø–æ–¥–∞–ª—å—à–∏—Ö –∫—Ä–æ–∫—ñ–≤\n\n"
        "–¶–µ –Ω–µ –∑–∞–º—ñ–Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—ó —Ç–µ—Ä–∞–ø—ñ—ó, –∞–ª–µ —Ñ–æ—Ä–º–∞—Ç, —è–∫–∏–π –º–æ–∂–µ:\n"
        "‚Ä¢ –¥–∞—Ç–∏ –≥–ª–∏–±—à–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Å–∏—Ç—É–∞—Ü—ñ—ó\n"
        "‚Ä¢ –∑–Ω–∏–∑–∏—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –Ω–∞–ø—Ä—É–≥—É\n"
        "‚Ä¢ –¥–æ–ø–æ–º–æ–≥—Ç–∏ –ø–æ–±–∞—á–∏—Ç–∏ —Ç–µ, —â–æ —Ä–∞–Ω—ñ—à–µ –Ω–µ –≤–¥–∞–≤–∞–ª–æ—Å—è –ø–æ–º—ñ—Ç–∏—Ç–∏\n\n"
        "–†–æ–±–æ—Ç–∞ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—à–µ, –Ω—ñ–∂ —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ–π —Å–µ—Å—ñ—ó,\n"
        "–∞–ª–µ –∑ —Ç—ñ—î—é –∂ —É–≤–∞–≥–æ—é –¥–æ –±–µ–∑–ø–µ–∫–∏ —ñ –º–µ–∂."
    ),
)

SERVICES["package"] = Service(
    key="package",
    title="üß© –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è",
    pay_url="https://secure.wayforpay.com/button/ba9f4b3175387",
    details_text=(
        "<b>üß© –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è</b>\n"
        "4 —Ä–µ–≥—É–ª—è—Ä–Ω—ñ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω—ñ –∑—É—Å—Ç—Ä—ñ—á—ñ ¬∑ 50 —Ö–≤\n"
        "(–∑—ñ –∑–Ω–∏–∂–∫–æ—é –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ —Ä–∞–∑–æ–≤–æ—é –æ–ø–ª–∞—Ç–æ—é)\n\n"
        "–¶–µ–π —Ñ–æ—Ä–º–∞—Ç —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —á–æ—Ç–∏—Ä—å–æ—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏—Ö —Å–µ—Å—ñ–π\n"
        "—ñ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å —Ç–∏–º, —Ö—Ç–æ –≥–æ—Ç–æ–≤–∏–π –æ–¥—Ä–∞–∑—É –∑–∞—Ö–æ–¥–∏—Ç–∏ –≤ –ø—Ä–æ—Ü–µ—Å.\n"
        "–§–æ—Ä–º–∞—Ç –ø—ñ–¥—ñ–π–¥–µ, —è–∫—â–æ:\n"
        "‚Ä¢ —î –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –ø–æ–≥–ª–∏–±–ª–µ–Ω–æ—ó —Ä–æ–±–æ—Ç–∏\n"
        "‚Ä¢ –≤–∞–∂–ª–∏–≤–∞ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —ñ —Ä–∏—Ç–º –∑—É—Å—Ç—Ä—ñ—á–µ–π\n"
        "‚Ä¢ —Ö–æ—á–µ—Ç—å—Å—è –¥–∞—Ç–∏ —Å–æ–±—ñ —á–∞—Å —ñ –ø—Ä–æ—Å—Ç—ñ—Ä –¥–ª—è –∑–º—ñ–Ω, –∞ –Ω–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏—Å—å –æ–¥–Ω—ñ—î—é —Å–µ—Å—ñ—î—é\n\n"
        "–ü–∞–∫–µ—Ç –¥–æ–∑–≤–æ–ª—è—î:\n"
        "‚Ä¢ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç\n"
        "‚Ä¢ –ø–æ—Å—Ç—É–ø–æ–≤–æ –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏\n"
        "‚Ä¢ —Ä—É—Ö–∞—Ç–∏—Å—å –±–µ–∑ –ø–æ—Å–ø—ñ—Ö—É, –∞–ª–µ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ"
    ),
)


# =========================
# FSM
# =========================

class Flow(StatesGroup):
    waiting_precontact = State()   # user writes message -> send to admin
    waiting_info = State()         # user writes message after info branch


# =========================
# Keyboards
# =========================

def start_kb():
    kb = InlineKeyboardBuilder()
    kb.button(text="üóì –ó–∞–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é", callback_data="go:booking")
    kb.button(text="‚ÑπÔ∏è –£—Ç–æ—á–Ω–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é", callback_data="go:info")
    kb.adjust(1)
    return kb.as_markup()

def booking_kb():
    kb = InlineKeyboardBuilder()
    # –ø–æ—Ä—è–¥–æ–∫ –∫–Ω–æ–ø–æ–∫: —è–∫ —Ç–∏ –Ω–∞–ø–∏—Å–∞–ª–∞ (–†–µ–≥—É–ª—è—Ä–Ω–∞, –ü–µ—Ä–≤–∏–Ω–Ω–∞, –†–∞–∑–æ–≤–∞, –§—ñ–∫—Å–æ–≤–∞–Ω–∞)
    kb.button(text="üå± –†–µ–≥—É–ª—è—Ä–Ω–∞ —Å–µ—Å—ñ—è", callback_data="svc:regular")
    kb.button(text="üß† –ü–µ—Ä–≤–∏–Ω–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á", callback_data="svc:initial")
    kb.button(text="üîç –†–∞–∑–æ–≤–∞ –≥–ª–∏–±–∏–Ω–Ω–∞ —Å–µ—Å—ñ—è", callback_data="svc:deep")
    kb.button(text="üß© –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è", callback_data="svc:package")
    kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="go:start")
    kb.adjust(1)
    return kb.as_markup()

def service_actions_kb(service_key: str):
    s = SERVICES[service_key]
    kb = InlineKeyboardBuilder()
    # Pay: URL button
    kb.add(InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é", url=s.pay_url))
    kb.button(text="üí¨ –ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–Ω—Ç–∞–∫—Ç", callback_data=f"precontact:{service_key}")
    kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="go:booking")
    kb.adjust(1)
    return kb.as_markup()

def info_root_kb():
    kb = InlineKeyboardBuilder()

    kb.button(
        text="üß≠ –Ø–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –ø—ñ–¥—ñ–π–¥–µ –ø—ñ–¥ –º—ñ–π –∑–∞–ø–∏—Ç?",
        callback_data="info:format"
    )
    kb.button(
        text="üí≥ –ü—Ä–æ –æ–ø–ª–∞—Ç—É —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω—ñ –¥–µ—Ç–∞–ª—ñ",
        callback_data="info:payment"
    )
    kb.button(
        text="üóì –ó–∞–ø–∏—Å —Ç–∞ —É–∑–≥–æ–¥–∂–µ–Ω–Ω—è —á–∞—Å—É",
        callback_data="info:booking"
    )
    kb.button(
        text="üò• –ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ —Å–∫–ª–∞–¥–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏—Å—å",
        callback_data="info:hard"
    )
    kb.button(
        text="‚úçüèª –Ü–Ω—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è",
        callback_data="info:other"
    )
    kb.button(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
        callback_data="go:start"
    )

    kb.adjust(1)
    return kb.as_markup()

def info_back_kb():
    kb = InlineKeyboardBuilder()
    kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="go:info")
    kb.adjust(1)
    return kb.as_markup()


def info_action_kb():
    kb = InlineKeyboardBuilder()

    kb.button(
        text="üóì –ó–∞–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é",
        callback_data="info:request"
    )
    kb.button(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
        callback_data="go:info"
    )

    kb.adjust(1)
    return kb.as_markup()


def info_after_answer_kb():
    kb = InlineKeyboardBuilder()
    kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="go:info")
    kb.adjust(1)
    return kb.as_markup()


# =========================
# Helpers
# =========================

async def safe_edit(cb: CallbackQuery, text: str, markup=None):
    try:
        await cb.message.edit_text(text, reply_markup=markup)
    except TelegramBadRequest as e:
        # –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ "message is not modified"
        if "message is not modified" in str(e):
            pass
        else:
            raise

def format_admin_payload(
    user,
    context_title: str,
    service_key: str | None,
    user_text: str,
):
    # user –º–æ–∂–µ –±—É—Ç–∏ Message –∞–±–æ User
    if hasattr(user, "from_user"):
        tg_user = user.from_user
    else:
        tg_user = user

    uname = f"@{tg_user.username}" if tg_user.username else "(–±–µ–∑ username)"
    name = tg_user.full_name
    uid = tg_user.id

    service_line = f"\n–ü–æ—Å–ª—É–≥–∞: {service_key}" if service_key else ""

    return (
        "üîî **–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞**\n\n"
        f"üë§ {name} {uname}\n"
        f"üÜî ID: `{uid}`\n"
        f"üìå {context_title}\n"
        f"{service_line}\n\n"
        f"üí¨ {user_text}"
    )


# =========================
# App
# =========================

bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())


@dp.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    await state.clear()
    await message.answer(START_TEXT, reply_markup=start_kb())


@dp.callback_query(F.data == "go:start")
async def go_start(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    await safe_edit(cb, START_TEXT, start_kb())
    await cb.answer()


@dp.callback_query(F.data == "go:booking")
async def go_booking(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    await safe_edit(cb, BOOKING_INTRO, booking_kb())
    await cb.answer()


@dp.callback_query(F.data.startswith("svc:"))
async def pick_service(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    service_key = cb.data.split(":", 1)[1]
    if service_key not in SERVICES:
        await cb.answer("–ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç", show_alert=True)
        return
    await safe_edit(cb, SERVICES[service_key].details_text, service_actions_kb(service_key))
    await cb.answer()

@dp.callback_query(F.data.startswith("pay:"))
async def go_pay(cb: CallbackQuery, state: FSMContext):
    service_key = cb.data.split(":", 1)[1]
    if service_key not in SERVICES:
        await cb.answer("–ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç", show_alert=True)
        return

@dp.callback_query(F.data == "info:request")
async def info_request(cb: CallbackQuery, state: FSMContext):
    await state.clear()

    text = (
        "üóì **–ó–∞–ø–∏—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é**\n\n"
        "–î—è–∫—É—é ü§ç\n"
        "–Ø –Ω–∞–ø–∏—à—É —Ç–æ–±—ñ –≤ –æ—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è,\n"
        "—â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –≤–∏–±–æ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç—É\n"
        "—Ç–∞ —É–∑–≥–æ–¥–∏—Ç–∏ –∑—Ä—É—á–Ω–∏–π –¥–µ–Ω—å —ñ —á–∞—Å."
    )

    await safe_edit(cb, text)
    await cb.answer()

    # üîî –ó–ê–Ø–í–ö–ê –¢–ê–ù–Ü ‚Äî –û–î–†–ê–ó–£
    if ADMIN_CHAT_ID and ADMIN_CHAT_ID != 0:
        payload = format_admin_payload(
            user=cb.from_user,
            context_title="–ó–∞–ø–∏—Å –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É",
            service_key=None,
            user_text="–ù–∞—Ç–∏—Å–Ω—É–ª–∞ ¬´–ó–∞–ø–∏—Å–∞—Ç–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é¬ª",
        )
        await bot.send_message(ADMIN_CHAT_ID, payload)


@dp.callback_query(F.data.startswith("precontact:"))
async def precontact(cb: CallbackQuery, state: FSMContext):
    service_key = cb.data.split(":", 1)[1]
    if service_key not in SERVICES:
        await cb.answer("–ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç", show_alert=True)
        return

    await state.set_state(Flow.waiting_precontact)
    await state.update_data(service_key=service_key)

    kb = InlineKeyboardBuilder()
    kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"svc:{service_key}")
    kb.adjust(1)

    await safe_edit(cb, PRECONTACT_TEXT, kb.as_markup())
    await cb.answer()


@dp.message(Flow.waiting_precontact)
async def got_precontact_message(message: Message, state: FSMContext):
    data = await state.get_data()

    service_key = data.get("service_key")  # –º–æ–∂–µ –±—É—Ç–∏ None
    topic = data.get("info_topic", "–ó–∞–ø–∏—Ç –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é")

    # –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    await message.answer(
        "–î—è–∫—É—é ü§ç\n"
        "–Ø –æ—Ç—Ä–∏–º–∞–ª–∞ —Ç–≤—ñ–π –∑–∞–ø–∏—Ç —ñ –Ω–∞–ø–∏—à—É —Ç–æ–±—ñ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å."
    )

    # –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –¢–∞–Ω—ñ
    if ADMIN_CHAT_ID and ADMIN_CHAT_ID != 0:
        payload = format_admin_payload(
            user=message,
            context_title=topic,
            service_key=service_key,
            user_text=message.text or "",
        )
        await bot.send_message(ADMIN_CHAT_ID, payload)

    await state.clear()


@dp.callback_query(F.data == "go:info")
async def go_info(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    await safe_edit(cb, INFO_ROOT_TEXT, info_root_kb())
    await cb.answer()


@dp.callback_query(F.data.startswith("info:"))
async def info_pick(cb: CallbackQuery, state: FSMContext):
    await state.clear()
    topic = cb.data.split(":", 1)[1]

    if topic == "format":
        await state.set_state(Flow.waiting_info)
        await safe_edit(cb, INFO_FORMAT_TEXT, info_action_kb())

    elif topic == "payment":
        await state.set_state(Flow.waiting_info)
        await safe_edit(cb, INFO_PAYMENT_TEXT, info_action_kb())

    elif topic == "booking":
        await state.set_state(Flow.waiting_info)
        await safe_edit(cb, INFO_BOOKING_TEXT, info_action_kb())

    elif topic == "hard":
        await state.set_state(Flow.waiting_info)
        await safe_edit(cb, INFO_HARD_TEXT, info_back_kb())
    
    elif topic == "other":
        await state.set_state(Flow.waiting_info)
        await safe_edit(cb, INFO_OTHER_TEXT, info_back_kb())
    
    else:
        await cb.answer("–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—É–Ω–∫—Ç", show_alert=True)
        return

    await cb.answer()

@dp.callback_query(F.data == "info:hard")
async def info_hard(cb: CallbackQuery, state: FSMContext):
    await state.set_state(Flow.waiting_precontact)
    await state.update_data(info_topic="–ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ —Å–∫–ª–∞–¥–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏—Å—å")

    text = (
        "üò• **–ú–µ–Ω—ñ –∑–∞—Ä–∞–∑ —Å–∫–ª–∞–¥–Ω–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏—Å—å**\n\n"
        "–¶–µ –æ–∫ ‚Äî –Ω–µ –∑–∞–≤–∂–¥–∏ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –æ–¥—Ä–∞–∑—É.\n\n"
        "–ú–æ–∂–µ—à –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—Å–∞—Ç–∏, —â–æ –∑ —Ç–æ–±–æ—é –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è\n"
        "–∞–±–æ —â–æ —Å–∞–º–µ –≤–∏–∫–ª–∏–∫–∞—î —Å—É–º–Ω—ñ–≤–∏.\n"
        "–Ø –≤—ñ–¥–ø–æ–≤—ñ–º –æ—Å–æ–±–∏—Å—Ç–æ."
    )

    await cb.message.edit_text(
        text,
        reply_markup=info_back_kb(),
        parse_mode="Markdown"
    )
    await cb.answer()

@dp.callback_query(F.data == "info:other")
async def info_other(cb: CallbackQuery, state: FSMContext):
    await state.set_state(Flow.waiting_precontact)
    await state.update_data(info_topic="–Ü–Ω—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è")

    text = (
        "‚úçÔ∏è **–Ü–Ω—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è**\n\n"
        "–ù–∞–ø–∏—à–∏, –±—É–¥—å –ª–∞—Å–∫–∞, —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è –æ–¥–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º.\n"
        "–Ø –≤—ñ–¥–ø–æ–≤—ñ–º –æ—Å–æ–±–∏—Å—Ç–æ."
    )

    await cb.message.edit_text(
        text,
        reply_markup=info_back_kb(),
        parse_mode="Markdown"
    )
    await cb.answer()


@dp.message(Flow.waiting_info)
async def got_info_message(message: Message, state: FSMContext):
    data = await state.get_data()
    topic = data.get("info_topic", "–£—Ç–æ—á–Ω–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é")

    await message.answer("–î—è–∫—É—é. –Ø –æ—Ç—Ä–∏–º–∞–ª–∞ —Ç–≤—ñ–π –∑–∞–ø–∏—Ç —ñ –Ω–∞–ø–∏—à—É —Ç–æ–±—ñ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å.")

    if ADMIN_CHAT_ID and ADMIN_CHAT_ID != 0:
        payload = format_admin_payload(
            user=message,
            context_title=f"‚ÑπÔ∏è –£—Ç–æ—á–Ω–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é ‚Üí {topic}",
            service_key=None,
            user_text=message.text or "",
        )
        await bot.send_message(ADMIN_CHAT_ID, payload)

    await state.clear()


async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())

